# 覆盖率高亮功能使用指南

## 功能概述

gocview 插件提供了强大的编辑器内覆盖率可视化功能，可以在代码编辑器中直接查看覆盖率信息。

## 主要特性

### 1. 代码块高亮

当你打开一个 Go 源文件时，插件会自动：

- **绿色背景**：标识已被执行的代码块
- **红色背景**：标识未被执行的代码块

这让你可以一眼看出哪些代码被测试覆盖了，哪些还没有。

### 2. 执行次数显示

在每个代码块的末尾，会显示一个执行次数标记：

```go
func main() {                    // ✓ 1
    fmt.Println("Hello")         // ✓ 70
    if condition {               // ✓ 50
        doSomething()            // ✓ 30
    }
}
```

- `✓ 数字`：表示该代码块被执行的次数
- 绿色标记：已覆盖
- 红色标记：未覆盖（执行次数为 0）

### 3. 详细信息提示

将鼠标悬停在高亮的代码块上，会显示详细的覆盖率信息：

```
覆盖率信息
位置: 8:13 - 9:6
语句数: 1
执行次数: 70
状态: 已覆盖
```

## 使用流程

### 步骤 1：启动带 Goc 的程序

首先，使用 goc 启动你的 Go 应用程序：

```bash
goc build -o myapp
./myapp
```

或者使用插件提供的 Goc Build 运行配置。

### 步骤 2：触发代码执行

运行你的应用程序，触发各种功能：

- 访问 HTTP 端点
- 调用 API
- 执行业务逻辑

### 步骤 3：获取覆盖率数据

在 "Goc Coverage" 工具窗口中：

1. 插件会自动检测 goc server 地址
2. 点击"刷新覆盖率"按钮获取最新数据
3. 或者等待自动刷新

### 步骤 4：查看编辑器高亮

打开任意 Go 源文件，你会看到：

- 代码块自动高亮（绿色/红色）
- 行末显示执行次数
- 可以悬停查看详细信息

### 步骤 5：跳转到代码

在工具窗口的详细信息面板中：

1. 选择一个文件
2. 查看该文件的所有代码块
3. 双击任意代码块
4. 编辑器会自动跳转到对应位置

## 技术实现

### 高亮层级

覆盖率高亮使用了 IntelliJ 平台的 MarkupModel API：

- 高亮层级：`HighlighterLayer.SELECTION - 1`
- 不会覆盖语法高亮和其他重要标记
- 与编辑器主题自动适配

### 内嵌提示

执行次数使用了 IntelliJ 平台的 Inlay API：

- 在行末添加内嵌元素
- 不影响代码编辑
- 自动跟随代码滚动

### 自动更新

编辑器高亮会在以下情况自动更新：

- 刷新覆盖率数据后
- 打开新文件时
- 切换文件时

## 性能优化

### 文件匹配

插件使用智能文件匹配算法：

1. 首先尝试精确匹配文件路径
2. 如果失败，尝试模糊匹配（文件名匹配）
3. 支持相对路径和绝对路径

### 资源管理

- 文件关闭时自动清理高亮和内嵌提示
- 避免内存泄漏
- 高效的数据结构存储覆盖率信息

## 常见问题

### Q: 为什么我的文件没有显示高亮？

A: 可能的原因：

1. 文件路径不匹配：goc 返回的路径可能是完整路径，而项目中是相对路径
2. 还没有获取覆盖率数据：先点击"刷新覆盖率"
3. 该文件没有覆盖率数据：可能是测试没有执行到这个文件

### Q: 如何清除高亮？

A: 有两种方式：

1. 在工具窗口中清空覆盖率数据
2. 关闭并重新打开文件

### Q: 高亮颜色可以自定义吗？

A: 当前版本使用固定的颜色方案：

- 已覆盖：绿色（浅色主题：#E8F5E9，深色主题：#1B5E20）
- 未覆盖：红色（浅色主题：#FFCDD2，深色主题：#B71C1C）

未来版本可能会支持自定义颜色。

### Q: 执行次数标记可以隐藏吗？

A: 当前版本会自动显示执行次数。如果你不需要这个功能，可以在设置中禁用（计划中的功能）。

## 最佳实践

### 1. 定期刷新

在开发过程中，定期刷新覆盖率数据：

- 执行新的测试后
- 修改代码后
- 添加新功能后

### 2. 关注未覆盖代码

红色高亮的代码块表示未被测试覆盖：

- 检查是否需要添加测试
- 确认是否是死代码
- 评估测试覆盖率目标

### 3. 分析执行次数

执行次数可以帮助你：

- 识别热点代码（执行次数高）
- 发现性能瓶颈
- 优化测试用例

### 4. 结合工具窗口使用

编辑器高亮和工具窗口配合使用：

- 工具窗口：查看整体覆盖率统计
- 编辑器高亮：查看具体代码的覆盖情况
- 双击跳转：快速定位到关注的代码

## 未来计划

- [ ] 支持自定义高亮颜色
- [ ] 支持显示/隐藏执行次数
- [ ] 支持覆盖率阈值告警
- [ ] 支持导出覆盖率报告
- [ ] 支持覆盖率趋势分析
